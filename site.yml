---
# ansible-playbook -i <INVENTORY-DIR>/prod-hosts site.yml

# New hosts are created in Compute Candada's openstack cloud
# infrastructure. requires a named cloud "cc_arbutus_rep, cc_arbutus_default, or"
# cc_arbutus_default_dev.
# Defined in clouds.yaml file with authentication credentials specific
# for that cloud/project. Create Instance with optional second disk mounted on
# /dev/vdb to act as the OMERO binary repository.

- name: Create/Configure UofA production instance
  hosts: omero
  tasks:
    - name: create the instance in the cloud
      import_role:
        name: sco.create_instance
      vars:
        cloud: cc_arbutus_default_dev
        create_second_volume: true
        floating_ip: 206.12.92.91
        flavour: "p8-12gb"
        image: Ubuntu-20.04-Focal-x64-2020-12
        #description: "University of Alberta's production OMERO server" - currently not used.
        boot_volume_size: 200
        server_name: "omero"
        keypair: "SteveOKeyPairCCOMERO"
        network: def-steveogg-dev-network
        security_group_list:
          - default
          - web
          - ssh
          - ping
          - omero
        second_volume_name: "binary_repository"
        seccond_volume_size_gb: 4500
        second_volume_description: "mount this on /OMERO to act as the binary repository"
        device: "/dev/vdb"
        
    - name: configure the newly created instance
      import_playbook: productionServer.yml
        vars:
          fqdn: "206-12-92-91.cloud.computecanada.ca"

- name: Create Training Server
  hosts: omero_dev
  tasks:
    - name: create training server instance"
      import_role:
        name: sco.create_instance
      vars:
        cloud: cc_arbutus_default_dev
        create_second_volume: true     
        floating_ip: 206.12.95.221
        flavour: "p4-6gb"
        image: Ubuntu-20.04-Focal-x64-2020-12
        boot_volume_size: 20
        server_name: "omero_training"
        #description: "OMERO server used for training workshops" -currently not used
        keypair: "SteveOKeyPairCCOMERO"
        network: "def-steveogg-dev-network"
        security_group_list:
          - default
          - web
          - ssh
          - ping
          - omero
        second_volume_name: "binary_repository"
        second_volume_description: "mount this on /OMERO to act as the binary repository"
        second_volume_size_gb: 50
        device: "/dev/vdb"
        
    - name: configure the newly created instance as a training server
      import_playbook: trainingServer.yml
      vars:
        fqdn: "206-12-95-221.cloud.computecanada.ca"
        
#Create National Production Server
- name: Create National OMERO Production Server
  hosts: national_omero
  tasks:
    - name: create the server instance in the cloud
      import_role:
        name: sco.create_instance
      vars:
        cloud: cc_arbutus_rpp
        create_second_volume: true     
        floating_ip: 206.12.94.73
        flavour: "p16-24gb"
        image: Ubuntu-20.04-Focal-x64-2020-12
        server_name: "national_omero"
        boot_volume_size: 200
        #server_description: "Canadian National OMERO production server" - currently not used
        keypair: "SteveOKeyPairCCOMERO"
        network: "rpp-steveogg-network"
        second_volume_name: "binary_repository"     
        second_volume_size_gb: 20000
        second_volume_description: "Volume to use as the OMERO binary repository"
        device: "/dev/vdb"
        security_group_list:
        - default
        - web
        - ping
        - omero
        - ssh
        
    - name: configure the national production server 
## Configure National OMERO.server. This is currently
## a one-node server hosting the db_server, omero_server and web_server from 
## a single instance.
    import_playbook: productionServer.yml
    vars:
      fqdn: "206-12-94-73.cloud.computecanada.ca"
      
      
##Create Backup Server
- name: Create backup server
  hosts: backup_server
  tasks:
    - name: Create backup server instance
      import_role:
        name: sco.create_instance
      vars:
        cloud: cc_arbutus_rpp
        create_second_volume: true     
        floating_ip: 206.12.94.9
        flavour: "p4-6gb"
        image: Ubuntu-20.04-Focal-x64-2020-12
        server_name: "omero_backup"
        boot_volume_size: 200
        #description: "server to act as backup for OMERO instance on 206.12.94.73" - currently not used
        keypair: "SteveOKeyPairCCOMERO"
        network: "rpp-steveogg-network"
        second_volume_name: "backup"     
        second_volume_size_gb: 20000
        second_volume_description: "Volume backup omero binary repository on 206.12.94.73"
        device: "/dev/vdb"
        security_group_list:
          - default
          - ssh
          - ping
          
    - name: configure newly created backup instance 
      import_playbook: rdiffBackup.yml
      vars:
        rdiff_backup_frequency: daily # or weekly or monthly
        second_volume_size_gb: 20000

# Internal monitoring configuration for all OMERO servers
- name: Create Prometheus Server
  hosts: prometheus
  tasks:
    - name: Create instance for prometheus and loki
      import_role:
        name: sco.create_instance
      vars:
        cloud: cc_arbutus_default
        create_second_volume: false     
        floating_ip: 206.12.94.110
        flavour: "p4-6gb"
        image: Ubuntu-20.04-Focal-x64-2020-12
        server_name: "prometheus"
        boot_volume_size: 9500
        #description: "" - currently not used
        keypair: "SteveOKeyPairCCOMERO"
        network: "def-steveogg-network"
        security_group_list:
          - default
          - ssh
          - ping
          
    - name: Install Prometheus, alertmanager, blackbox-exporter and loki
      import_playbook: configurePrometheus.yml

- name: Create Grafana server
  hosts: grafana
  tasks:
    - name: create instance to use as grafana server
      import_role:
        name: sco.create_instance
      vars:
        cloud: cc_arbutus_default
        create_second_volume: false     
        floating_ip: 206.12.92.26
        flavour: "p4-6gb"
        image: Ubuntu-20.04-Focal-x64-2020-12
        server_name: "grafana"
        boot_volume_size: 500
        #description: "" - currently not used
        keypair: "SteveOKeyPairCCOMERO"
        network: "def-steveogg-network"
        security_group_list:
          - default
          - ssh
          - web
          - ping
          
    - name: install grafana, get certificate to deploy on https:xxxxx:443
      import_playbook: configureGrafana.yml
    

  
    
